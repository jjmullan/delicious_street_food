#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# post-checkout: ë¸Œëœì¹˜ ì „í™˜ ì‹œ ì˜ì¡´ì„± ë³€ê²½ ê°ì§€
# package.json ë˜ëŠ” pnpm-lock.yamlì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ pnpm install ì‹¤í–‰

# $1: ì´ì „ HEADì˜ ref
# $2: ìƒˆë¡œìš´ HEADì˜ ref
# $3: ë¸Œëœì¹˜ ì „í™˜ ì—¬ë¶€ (1=ë¸Œëœì¹˜ ì „í™˜, 0=íŒŒì¼ ì²´í¬ì•„ì›ƒ)

# ë¸Œëœì¹˜ ì „í™˜ì´ ì•„ë‹ˆë©´ ì¢…ë£Œ
[ "$3" = "0" ] && exit 0

prev_ref=$1
new_ref=$2

# ì˜ì¡´ì„± íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
changed_files="$(git diff --name-only $prev_ref $new_ref)"

if echo "$changed_files" | grep -qE "package\.json|pnpm-lock\.yaml"; then
  echo "\nğŸ“¦ ë¸Œëœì¹˜ ì „í™˜ìœ¼ë¡œ ì¸í•´ ì˜ì¡´ì„± íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "pnpm installì„ ì‹¤í–‰í•©ë‹ˆë‹¤...\n"

  pnpm install

  if [ $? -eq 0 ]; then
    echo "\nâœ… ì˜ì¡´ì„±ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n"
  else
    echo "\nâš ï¸  ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ 'pnpm install'ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.\n"
  fi
fi
