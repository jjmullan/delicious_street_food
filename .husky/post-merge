#!/usr/bin/env sh

# PATH 설정 (GUI 환경에서도 pnpm과 git을 찾을 수 있도록)
export PATH="/usr/local/bin:$HOME/.local/share/pnpm:$PATH"

# post-merge: merge 후 자동화 작업 수행
# 1. 의존성 자동 설치 (package.json, pnpm-lock.yaml 변경 시)
# 2. 빌드 캐시 정리 및 자동 빌드 (소스 코드/설정 파일 변경 시)

# pnpm이 설치되어 있는지 확인
if ! command -v pnpm >/dev/null 2>&1; then
  echo "⚠️  Warning: pnpm not found. Skipping post-merge tasks."
  exit 0
fi

# 변경된 파일 목록 가져오기
changed_files="$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null || echo "")"

# 1️⃣ 의존성 자동 설치
if echo "$changed_files" | grep -qE "package\.json|pnpm-lock\.yaml"; then
  echo "\n📦 의존성 파일이 변경되었습니다. pnpm install을 실행합니다...\n"
  pnpm install

  if [ $? -eq 0 ]; then
    echo "✅ 의존성이 성공적으로 업데이트되었습니다.\n"
  else
    echo "⚠️  의존성 설치 중 문제가 발생했습니다. 수동으로 'pnpm install'을 실행해주세요.\n"
  fi
fi

# 2️⃣ 빌드 캐시 정리 및 자동 빌드
# 소스 코드 또는 설정 파일이 변경되었는지 확인
if echo "$changed_files" | grep -qE "^src/|vite\.config\.|tsconfig.*\.json|package\.json"; then
  echo "🔨 소스 코드 또는 설정 파일이 변경되었습니다."
  echo "빌드 캐시를 정리하고 새로 빌드합니다...\n"

  # 캐시 정리
  echo "🧹 캐시 정리 중..."
  rm -rf dist .vite node_modules/.vite 2>/dev/null
  echo "✅ 캐시가 정리되었습니다.\n"

  # 빌드 실행
  echo "🔧 프로젝트를 빌드합니다..."
  pnpm build

  if [ $? -eq 0 ]; then
    echo "\n✅ 빌드가 성공적으로 완료되었습니다.\n"
  else
    echo "\n⚠️  빌드 중 문제가 발생했습니다."
    echo "💡 'pnpm build'를 수동으로 실행하여 문제를 확인해주세요.\n"
  fi
fi

exit 0
